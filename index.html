
<!--span标签是内联元素，不像块级元素（如：div标签、p标签等）那样有换行的效果；-->










<!DOCTYPE html>
<!-- 这是HTML文档的起始标签，声明文档语言为中文（中国）。 -->
<html lang="zh-CN">
<head>
  
    <meta charset="UTF-8">
    <!-- 设置视口，使页面在移动设备上正确显示。 -->
       <!-- 
        视口（viewport）是指浏览器中网页内容的可视区域。通过设置<meta name="viewport">标签，可以控制网页在不同设备（如移动端和PC端）上的缩放和布局行为。
        移动端常用设置如下：
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        这表示视口宽度等于设备宽度，初始缩放比例为1，适合响应式布局。

        PC端通常不需要特别设置视口，默认即可。如果需要兼容移动端和PC端，建议统一使用上述设置。
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 设置页面标题。 -->
    <title>羊羊远程天文台控制系统</title>
    <!-- 定义CSS样式，用于控制页面布局和样式。 -->
    <style>
        /* 全局样式，设置所有元素的边距、内边距和盒模型。 */
        /*
         * 这段CSS的意思是：
         * 对所有HTML元素（* 选择器）应用如下样式：
         * margin: 0;           // 外边距设为0，消除默认外边距
         * padding: 0;          // 内边距设为0，消除默认内边距
         * box-sizing: border-box; // 盒模型以border-box计算，包含内边距和边框
         *
         * box-sizing 还有其他常见的样式值：
         * 1. content-box（默认值）：宽高只包含内容区域，不包括内边距和边框。
         * 2. border-box：宽高包含内容、内边距和边框（推荐用于布局）。
         * 3. padding-box（较少用，部分浏览器支持）：宽高包含内容和内边距，不包括边框。
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /*
         * 这段CSS的意思是：
         * 对body元素应用如下样式：
         * font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
         * 设置字体为Segoe UI、Tahoma、Geneva、Verdana和sans-serif的组合
         * background-color: #f5f5f5; 
         * 设置背景颜色为浅灰色
         * color: #333; 
         * 设置文本颜色为深灰色
         * line-height: 1.6; 
         * 设置行高为1.6倍
         */
        body {
            /* font-family用于设置字体。这里依次指定了'Segoe UI'、Tahoma、Geneva、Verdana和sans-serif，浏览器会按顺序查找可用字体，最后用sans-serif作为兜底。 */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /*
         * 这段CSS的意思是：
         * 对class为container的元素应用如下样式：
         * max-width: 1200px; // 设置最大宽度为1200像素
         * margin: 0 auto; // 设置外边距为0，水平居中
         * padding: 20px; // 设置内边距为20像素
         */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /*
         * 这段CSS的意思是：
         * 对class为header的元素应用如下样式：
         * text-align: center; // 设置文本居中对齐
         * margin-bottom: 30px; // 设置下外边距为30像素
         * padding: 20px; // 设置内边距为20像素
         * background: #fff; // 设置背景颜色为白色
         * border-radius: 10px; // 设置圆角为10像素
         * box-shadow: 0 2px 10px rgba(0,0,0,0.1); // 设置阴影，颜色为黑色，透明度为0.1
         */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        /*
         * 这段CSS的意思是：
         * 对class为header的元素中的h1子元素应用如下样式：
         * color: #000; // 设置文本颜色为黑色
         * font-size: 2.5em; // 设置字体大小为2.5倍
         * margin-bottom: 10px; // 设置下外边距为10像素
         */
        .header h1 {
            color: #000;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }
        /*
         * 这段CSS的意思是：
         * 对class为grid的元素应用如下样式：
         * display: grid; // 设置为网格布局
         * grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
         * 设置列数为自动适应，最小宽度为300像素，最大宽度为1fr
         * gap: 20px; // 设置网格间距为20像素
         * margin-bottom: 30px; // 设置下外边距为30像素
         */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        /*
         * 这段CSS的意思是：
         * 对class为card的元素应用如下样式：
         * background: #fff; // 设置背景颜色为白色
         * border-radius: 10px; // 设置圆角为10像素
         * padding: 25px; // 设置内边距为25像素
         * box-shadow: 0 2px 10px rgba(0,0,0,0.1); // 设置阴影，颜色为黑色，透明度为0.1 
         * transition: transform 0.2s ease; // 设置过渡效果，变换时间为0.2秒，平滑过渡
         */
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            color: #000;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 5px;
        }

        .data-label {
            font-weight: 600;
            color: #333;
        }

        .data-value {
            font-weight: bold;
            color: #000;
            font-size: 1.1em;
        }
        /*
         * 这段CSS的意思是：
         * 对class为status-indicator的元素应用如下样式：
         * display: inline-block; // 设置为内联块级元素
         * width: 12px; // 设置宽度为12像素
         * height: 12px; // 设置高度为12像素
         * border-radius: 50%; // 设置圆角为50% 
         * margin-right: 8px; // 设置右外边距为8像素
         */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-on {
            background-color: #28a745;
        }

        .status-off {
            background-color: #dc3545;
        }

        .control-button {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        /*悬停效果*/
        .control-button:hover {
            background: #333;
            transform: translateY(-1px);
        }
        /*激活效果*/
        .control-button.active {
            background: #28a745;
        }
        /*危险效果*/
        .control-button.danger {
            background: #dc3545;
        }
        /*危险效果悬停*/
        .control-button.danger:hover {
            background: #c82333;
        }

        .timer-section {
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #000;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #000;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /*
         * 这段CSS的意思是：
         * 对class为terminal的元素应用如下样式：
         * background: #000; // 设置背景颜色为黑色
         * color: #fff; // 设置文本颜色为白色
         * padding: 20px; // 设置内边距为20像素
         * border-radius: 10px; // 设置圆角为10像素
         * font-family: 'Courier New', monospace; // 设置字体为Courier New和monospace的组合
         * height: 300px; // 设置高度为300像素
         * overflow-y: auto; // 设置垂直滚动
         * margin-top: 20px; // 设置上外边距为20像素
         */
        .terminal {
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .terminal-line {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* 摄像头视频流样式 */
        .camera-section {
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .video-stream {
            width: 100%;
            height: 360px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2em;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .camera-info {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .camera-info h3 {
            margin-bottom: 10px;
            color: #000;
        }

        .camera-info p {
            margin: 5px 0;
            color: #666;
        }

        .rtsp-url {
            background: #000;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }

            .video-stream {
                height: 240px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>羊羊远程天文台控制系统</h1>
            <p>实时监控和控制天文台设备状态</p>
        </div>

        <!-- 传感器数据 -->
        <div class="grid">
            <div class="card">
                <h2>环境传感器</h2>
                <div class="data-item">
                    <span class="data-label">DHT11温度:</span>
                    <span class="data-value" id="dht-temperature">--°C</span>
                </div>
                <div class="data-item">
                    <span class="data-label">DHT11湿度:</span>
                    <span class="data-value" id="dht-humidity">--%</span>
                </div>
                <div class="data-item">
                    <span class="data-label">UTC温度:</span>
                    <span class="data-value" id="utc-temperature">--°C</span>
                </div>
                <div class="data-item">
                    <span class="data-label">雨水检测:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="rain-indicator"></span>
                        <span id="rain-status">--</span>
                    </span>
                </div>
            </div>

            <div class="card">
                <h2>电源监控</h2>
                <div class="data-item">
                    <span class="data-label">输出电压:</span>
                    <span class="data-value" id="output-voltage">--V</span>
                </div>
                <div class="data-item">
                    <span class="data-label">输出电流:</span>
                    <span class="data-value" id="output-current">--A</span>
                </div>
                <div class="data-item">
                    <span class="data-label">输出功率:</span>
                    <span class="data-value" id="output-power">--W</span>
                </div>
                <div class="data-item">
                    <span class="data-label">MOSFET状态:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="mosfet-indicator"></span>
                        <span id="mosfet-status">--</span>
                    </span>
                </div>
            </div>

            <div class="card">
                <h2>设备控制</h2>
                <div class="data-item">
                    <span class="data-label">电机状态:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="motor-indicator"></span>
                        <span id="motor-status">--</span>
                    </span>
                </div>
                <div class="data-item">
                    <span class="data-label">加热片状态:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="heater-indicator"></span>
                        <span id="heater-status">--</span>
                    </span>
                </div>
                <div class="data-item">
                    <span class="data-label">摄像头状态:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="camera-indicator"></span>
                        <span id="camera-status">--</span>
                    </span>
                </div>
                <div class="data-item">
                    <span class="data-label">蓝牙连接:</span>
                    <span class="data-value">
                        <span class="status-indicator" id="bluetooth-indicator"></span>
                        <span id="bluetooth-status">--</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- 摄像头视频流 -->
        <div class="camera-section">
            <h2>摄像头监控</h2>
            <div class="video-container">
                <div class="video-stream" id="video-stream">
                    <div>摄像头未开启</div>
                </div>
            </div>
            
            <div class="video-controls">
                <button class="control-button" id="camera-on-btn" onclick="controlCamera('on')">开启摄像头</button>
                <button class="control-button danger" id="camera-off-btn" onclick="controlCamera('off')">关闭摄像头</button>
                <button class="control-button" onclick="refreshVideoStream()">刷新视频流</button>
            </div>

            <div class="camera-info">
                <h3>摄像头配置信息</h3>
                <p><strong>摄像头类型:</strong> 海康摄像头 (HIKVISION)</p>
                <div class="input-group">
                    <label>RTSP地址:</label>
                    <input type="text" id="rtsp-url-input" value="rtsp://admin:Czh040731@10.168.1.102:554/Streaming/Channels/101?transportmode=unicast&profile=Profile_1" style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.9em;" onchange="updateRTSPUrl(this.value)">
                </div>
                <div class="input-group">
                    <label>视频流类型:</label>
                    <select id="stream-type" onchange="updateStreamType(this.value)">
                        <option value="webrtc">WebRTC (推荐)</option>
                        <option value="hls">HLS (HTTP Live Streaming)</option>
                        <option value="dash">DASH (Dynamic Adaptive Streaming)</option>
                        <option value="mjpeg">MJPEG (Motion JPEG)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>WebRTC服务器地址:</label>
                    <input type="text" id="webrtc-server" value="ws://localhost:8080" style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.9em;" onchange="updateWebRTCServer(this.value)">
                </div>
                <div class="input-group">
                    <label>HLS服务器地址:</label>
                    <input type="text" id="hls-server" value="http://localhost:8081" style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.9em;" onchange="updateHLSServer(this.value)">
                </div>
                <p><strong>自动关闭时间:</strong> <span id="camera-auto-off-display">10</span>分钟</p>
                <p><strong>运行时间:</strong> <span id="camera-runtime">--</span></p>
                <p><strong>电源状态:</strong> <span id="camera-power-status">关闭</span></p>
            </div>
        </div>

        <!-- 电机控制 -->
        <div class="card">
            <h2>电机控制</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                <button class="control-button" onclick="controlMotor('forward')">正转自锁</button>
                <button class="control-button" onclick="controlMotor('reverse')">反转自锁</button>
                <button class="control-button danger" onclick="controlMotor('stop')">停止</button>
            </div>
            
            <div class="input-group">
                <label>自动关顶开关:</label>
                <label class="switch">
                    <input type="checkbox" id="autoclose-motor">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!--
        onclick 按钮按下
        onchange - 值改变时触发
        onload - 页面加载完成时触发
        onmouseover - 鼠标悬停时触发
        onmouseout - 鼠标离开时触发
        onmousemove - 鼠标移动时触发
        onmouseup - 鼠标松开时触发
        onmousedown - 鼠标按下时触发
        onmousewheel - 鼠标滚轮滚动时触发
        onscroll - 滚动条滚动时触发
        -->

        <!-- 加热片控制 -->
        <div class="card">
            <h2>加热片控制</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                <button class="control-button" id="heater-manual-btn" onclick="controlHeater('manual')">手动模式</button>
                <button class="control-button" id="heater-auto-btn" onclick="controlHeater('auto')">自动模式</button>
                <button class="control-button" id="heater-on-btn" onclick="controlHeater('on')">开启加热</button>
                <button class="control-button danger" id="heater-off-btn" onclick="controlHeater('off')">关闭加热</button>
            </div>
            
            <div class="input-group">
                <label>湿度阈值 (%):</label>
                <input type="number" id="humidity-threshold" min="0" max="100" value="70">
            </div>
            <div class="input-group">
                <label>温度差值 (°C):</label>
                <input type="number" id="temp-diff-threshold" min="0" max="30" value="5">
            </div>
        </div>

        <!-- 定时器设置 -->
        <div class="timer-section">
            <h2>定时器设置</h2>
            <div class="input-group">
                <label>定时器总开关:</label>
                <label class="switch">
                    <input type="checkbox" id="timer-enabled">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="timer-controls">
                <div class="input-group">
                    <label>启动时间:</label>
                    <input type="time" id="start-time">
                </div>
                <div class="input-group">
                    <label>停止时间:</label>
                    <input type="time" id="stop-time">
                </div>
                <div class="input-group">
                    <label>启动类型:</label>
                    <select id="start-type">
                        <option value="time">固定时间</option>
                        <option value="sunrise">日出</option>
                        <option value="sunset">日落</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>停止类型:</label>
                    <select id="stop-type">
                        <option value="time">固定时间</option>
                        <option value="sunrise">日出</option>
                        <option value="sunset">日落</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <label>生效星期:</label>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <label><input type="checkbox" checked> 周一</label>
                    <label><input type="checkbox" checked> 周二</label>
                    <label><input type="checkbox" checked> 周三</label>
                    <label><input type="checkbox" checked> 周四</label>
                    <label><input type="checkbox" checked> 周五</label>
                    <label><input type="checkbox" checked> 周六</label>
                    <label><input type="checkbox" checked> 周日</label>
                </div>
            </div>
        </div>

        <!-- 蓝牙控制 -->
        <div class="card">
            <h2>蓝牙控制</h2>
            <div class="input-group">
                <label>蓝牙开关:</label>
                <label class="switch">
                    <input type="checkbox" id="bluetooth-switch" onchange="toggleBluetooth(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;">
                <button class="control-button" onclick="bluetoothControl('sync-time')">同步时间日期</button>
                <button class="control-button" onclick="bluetoothControl('go-zero')">回零位</button>
                <button class="control-button" onclick="bluetoothControl('go-park')">回停放位</button>
                <button class="control-button" onclick="bluetoothControl('set-zero')">设置为零位</button>
                <button class="control-button" onclick="bluetoothControl('set-park')">设置为停放位</button>
            </div>
        </div>

        <!-- 系统设置 -->
        <div class="card">
            <h2>系统设置</h2>
            <div class="input-group">
                <label>上报间隔 (秒):</label>
                <input type="number" id="report-interval" min="1" max="300" value="5" onchange="updateSystemSetting('report-interval', this.value)">
            </div>
            <div class="input-group">
                <label>ESP-NOW发送间隔 (秒):</label>
                <input type="number" id="espnow-interval" min="1" max="60" value="5" onchange="updateSystemSetting('espnow-interval', this.value)">
            </div>
            <div class="input-group">
                <label>湿度阈值 (%):</label>
                <input type="number" id="humidity-threshold-setting" min="0" max="100" value="70" onchange="updateSystemSetting('humidity-threshold', this.value)">
            </div>
            <div class="input-group">
                <label>温度差值 (°C):</label>
                <input type="number" id="temp-diff-threshold-setting" min="0" max="30" value="5" onchange="updateSystemSetting('temp-diff-threshold', this.value)">
            </div>
            <div class="input-group">
                <label>自动关闭时间 (分钟):</label>
                <input type="number" id="camera-auto-off" min="1" max="60" value="10" onchange="updateSystemSetting('camera-auto-off', this.value)">
            </div>
            <button class="control-button" onclick="restoreDefaults()">恢复默认设置</button>
        </div>

        <!-- 系统日志 -->
        <div class="card">
            <h2>系统日志</h2>
            <div class="terminal" id="terminal">
                <div class="terminal-line">=== 远程天文台控制系统启动 ===</div>
                <div class="terminal-line">时间同步已配置</div>
                <div class="terminal-line">所有模块初始化完成</div>
                <div class="terminal-line">==============================</div>
            </div>
        </div>
    </div>

    <script>
        // 摄像头相关变量
        let cameraStream = null;
        let cameraStartTime = 0;
        let cameraRuntimeInterval = null;

        // 更新真实数据
        function updateRealData(data) {
            // 更新传感器数据
            if (data.dhtTemperature !== undefined) {
                document.getElementById('dht-temperature').textContent = data.dhtTemperature.toFixed(1) + '°C';
            }
            if (data.dhtHumidity !== undefined) {
                document.getElementById('dht-humidity').textContent = data.dhtHumidity.toFixed(1) + '%';
            }
            if (data.utcTemperature !== undefined) {
                document.getElementById('utc-temperature').textContent = data.utcTemperature.toFixed(1) + '°C';
            }
            if (data.outputVoltage !== undefined) {
                document.getElementById('output-voltage').textContent = data.outputVoltage.toFixed(2) + 'V';
            }
            if (data.outputCurrent !== undefined) {
                document.getElementById('output-current').textContent = data.outputCurrent.toFixed(2) + 'A';
            }
            if (data.powerOutput !== undefined) {
                document.getElementById('output-power').textContent = data.powerOutput.toFixed(2) + 'W';
            }
            
            // 更新状态指示器
            if (data.rainDetected !== undefined) {
                updateStatusIndicator('rain', data.rainDetected);
            }
            if (data.motorState !== undefined) {
                updateStatusIndicator('motor', data.motorState);
            }
            if (data.heaterState !== undefined) {
                updateStatusIndicator('heater', data.heaterState);
            }
            if (data.cameraState !== undefined) {
                updateStatusIndicator('camera', data.cameraState);
            }
            if (data.mosfetState !== undefined) {
                updateStatusIndicator('mosfet', data.mosfetState);
            }
            if (data.bluetoothConnected !== undefined) {
                updateStatusIndicator('bluetooth', data.bluetoothConnected);
            }
            
            // 更新系统设置
            if (data.reportInterval !== undefined) {
                document.getElementById('report-interval').value = data.reportInterval;
            }
            if (data.espnowInterval !== undefined) {
                document.getElementById('espnow-interval').value = data.espnowInterval;
            }
            if (data.humidityThreshold !== undefined) {
                document.getElementById('humidity-threshold-setting').value = data.humidityThreshold;
                document.getElementById('humidity-threshold').value = data.humidityThreshold;
            }
            if (data.tempDiffThreshold !== undefined) {
                document.getElementById('temp-diff-threshold-setting').value = data.tempDiffThreshold;
                document.getElementById('temp-diff-threshold').value = data.tempDiffThreshold;
            }
            if (data.cameraAutoOff !== undefined) {
                document.getElementById('camera-auto-off').value = data.cameraAutoOff;
                document.getElementById('camera-auto-off-display').textContent = data.cameraAutoOff;
            }
            
            // 更新摄像头信息
            if (data.cameraRuntime !== undefined) {
                const minutes = Math.floor(data.cameraRuntime / 60);
                const seconds = data.cameraRuntime % 60;
                document.getElementById('camera-runtime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            if (data.cameraPowerStatus !== undefined) {
                document.getElementById('camera-power-status').textContent = data.cameraPowerStatus;
            }
        }

        // 模拟数据更新
        function updateSensorData() {
            // 模拟传感器数据
            const mockData = {
                dhtTemperature: (20 + Math.random() * 10).toFixed(1),
                dhtHumidity: (40 + Math.random() * 30).toFixed(1),
                utcTemperature: (18 + Math.random() * 8).toFixed(1),
                outputVoltage: (12 + Math.random() * 2).toFixed(2),
                outputCurrent: (1 + Math.random() * 3).toFixed(2),
                outputPower: (12 + Math.random() * 20).toFixed(2),
                rainDetected: Math.random() > 0.8,
                motorState: Math.random() > 0.5,
                heaterState: Math.random() > 0.5,
                cameraState: Math.random() > 0.5,
                mosfetState: Math.random() > 0.5,
                bluetoothConnected: Math.random() > 0.7
            };

            // 更新显示
            document.getElementById('dht-temperature').textContent = mockData.dhtTemperature + '°C';
            document.getElementById('dht-humidity').textContent = mockData.dhtHumidity + '%';
            document.getElementById('utc-temperature').textContent = mockData.utcTemperature + '°C';
            document.getElementById('output-voltage').textContent = mockData.outputVoltage + 'V';
            document.getElementById('output-current').textContent = mockData.outputCurrent + 'A';
            document.getElementById('output-power').textContent = mockData.outputPower + 'W';

            // 更新状态指示器
            updateStatusIndicator('rain', mockData.rainDetected);
            updateStatusIndicator('motor', mockData.motorState);
            updateStatusIndicator('heater', mockData.heaterState);
            updateStatusIndicator('camera', mockData.cameraState);
            updateStatusIndicator('mosfet', mockData.mosfetState);
            updateStatusIndicator('bluetooth', mockData.bluetoothConnected);
        }

        function updateStatusIndicator(type, state) {
            const indicator = document.getElementById(type + '-indicator');
            const status = document.getElementById(type + '-status');
            
            if (indicator && status) {
                indicator.className = 'status-indicator ' + (state ? 'status-on' : 'status-off');
                status.textContent = state ? '开启' : '关闭';
            }
        }

        // 摄像头控制函数
        function controlCamera(action) {
            if (action === 'on') {
                startCameraStream();
                addLog('摄像头已开启');
            } else if (action === 'off') {
                stopCameraStream();
                addLog('摄像头已关闭');
            }
        }

        // WebRTC相关变量
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;

        function startCameraStream() {
            const videoStream = document.getElementById('video-stream');
            const cameraPowerStatus = document.getElementById('camera-power-status');
            
            // 启动摄像头
            videoStream.innerHTML = '<div>正在启动摄像头...</div>';
            cameraPowerStatus.textContent = '启动中';
            
            // 获取RTSP地址
            const rtspUrl = document.getElementById('rtsp-url-input').value;
            
            setTimeout(() => {
                // 创建视频元素
                videoStream.innerHTML = `
                    <video id="video-player" autoplay muted style="width: 100%; height: 100%; object-fit: cover;">
                        您的浏览器不支持视频播放
                    </video>
                    <div id="stream-info" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; border-radius: 3px; font-size: 0.8em;">
                        RTSP: ${rtspUrl}
                    </div>
                `;
                
                cameraPowerStatus.textContent = '开启';
                
                // 开始计时
                cameraStartTime = Date.now();
                startCameraRuntime();
                
                // 尝试连接WebRTC流
                connectWebRTCStream(rtspUrl);
                
                addLog('摄像头启动完成');
                addLog(`[调试] 正在连接RTSP流: ${rtspUrl}`);
            }, 2000);
        }

        // 视频流配置变量
        let currentStreamType = 'webrtc';
        let webrtcServerUrl = 'ws://localhost:8080';
        let hlsServerUrl = 'http://localhost:8081';

        // WebRTC连接函数
        function connectWebRTCStream(rtspUrl) {
            addLog('[WebRTC] 开始建立连接...');
            
            const streamType = document.getElementById('stream-type').value;
            currentStreamType = streamType;
            
            switch(streamType) {
                case 'webrtc':
                    connectToWebRTCServer(webrtcServerUrl, rtspUrl);
                    break;
                case 'hls':
                    connectHLSStream(rtspUrl);
                    break;
                case 'dash':
                    connectDASHStream(rtspUrl);
                    break;
                case 'mjpeg':
                    connectMJPEGStream(rtspUrl);
                    break;
                default:
                    addLog('[错误] 不支持的视频流类型: ' + streamType);
            }
        }

        // 更新视频流类型
        function updateStreamType(type) {
            addLog(`[视频流配置] 流类型已更改为: ${type}`);
            currentStreamType = type;
        }

        // 更新WebRTC服务器地址
        function updateWebRTCServer(url) {
            addLog(`[视频流配置] WebRTC服务器地址已更新: ${url}`);
            webrtcServerUrl = url;
        }

        // 更新HLS服务器地址
        function updateHLSServer(url) {
            addLog(`[视频流配置] HLS服务器地址已更新: ${url}`);
            hlsServerUrl = url;
        }

        // 连接到Janus WebRTC Gateway
        function connectToJanusGateway(rtspUrl) {
            addLog('[Janus] 连接到Janus WebRTC Gateway...');
            
            // Janus WebRTC Gateway配置
            const janusConfig = {
                server: 'ws://your-janus-server:8188',
                plugin: 'janus.plugin.streaming',
                rtspUrl: rtspUrl
            };
            
            // 这里需要实现Janus WebRTC连接逻辑
            addLog('[Janus] 需要实现Janus WebRTC连接代码');
        }

        // 连接到自定义WebRTC服务器
        function connectToWebRTCServer(wsUrl, rtspUrl) {
            addLog('[WebRTC] 连接到WebRTC服务器...');
            
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                addLog('[WebRTC] WebSocket连接已建立');
                ws.send(JSON.stringify({
                    type: 'start_stream',
                    rtsp_url: rtspUrl
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'offer') {
                    handleWebRTCOffer(data.offer);
                }
            };
            
            ws.onerror = function(error) {
                addLog('[WebRTC] 连接错误: ' + error);
            };
        }

        // 处理WebRTC Offer
        function handleWebRTCOffer(offer) {
            addLog('[WebRTC] 收到Offer，开始建立连接...');
            
            const videoElement = document.getElementById('video-player');
            
            // 创建RTCPeerConnection
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            // 处理远程流
            peerConnection.ontrack = function(event) {
                addLog('[WebRTC] 收到远程视频流');
                videoElement.srcObject = event.streams[0];
            };
            
            // 设置远程描述
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => {
                    return peerConnection.createAnswer();
                })
                .then(answer => {
                    return peerConnection.setLocalDescription(answer);
                })
                .then(() => {
                    addLog('[WebRTC] 连接建立成功');
                })
                .catch(error => {
                    addLog('[WebRTC] 连接失败: ' + error);
                });
        }

        function stopCameraStream() {
            const videoStream = document.getElementById('video-stream');
            const cameraPowerStatus = document.getElementById('camera-power-status');
            
            videoStream.innerHTML = '<div>摄像头未开启</div>';
            cameraPowerStatus.textContent = '关闭';
            
            // 停止计时
            if (cameraRuntimeInterval) {
                clearInterval(cameraRuntimeInterval);
                cameraRuntimeInterval = null;
            }
            
            addLog('摄像头已关闭');
        }

        function startCameraRuntime() {
            if (cameraRuntimeInterval) {
                clearInterval(cameraRuntimeInterval);
            }
            
            cameraRuntimeInterval = setInterval(() => {
                const runtime = Math.floor((Date.now() - cameraStartTime) / 1000);
                const minutes = Math.floor(runtime / 60);
                const seconds = runtime % 60;
                document.getElementById('camera-runtime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // HLS视频流支持
        function connectHLSStream(rtspUrl) {
            addLog('[HLS] 尝试连接HLS流...');
            
            // 将RTSP转换为HLS流
            // 需要服务器端将RTSP转换为HLS格式
            const hlsUrl = convertRTSPtoHLS(rtspUrl);
            
            const videoElement = document.getElementById('video-player');
            
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(hlsUrl);
                hls.attachMedia(videoElement);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    addLog('[HLS] 视频流加载成功');
                    videoElement.play();
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    addLog('[HLS] 错误: ' + data.details);
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari原生支持HLS
                videoElement.src = hlsUrl;
                videoElement.addEventListener('loadedmetadata', function() {
                    addLog('[HLS] Safari原生HLS流加载成功');
                    videoElement.play();
                });
            }
        }

        // 将RTSP转换为HLS的函数
        function convertRTSPtoHLS(rtspUrl) {
            // 这里需要服务器端支持
            // 可以使用FFmpeg将RTSP转换为HLS
            const streamId = encodeURIComponent(rtspUrl);
            return `${hlsServerUrl}/hls/${streamId}/playlist.m3u8`;
        }

        // DASH流连接
        function connectDASHStream(rtspUrl) {
            addLog('[DASH] 尝试连接DASH流...');
            const dashUrl = convertRTSPtoDASH(rtspUrl);
            addLog('[DASH] DASH流地址: ' + dashUrl);
            // 这里需要DASH.js库来播放DASH流
        }

        // MJPEG流连接
        function connectMJPEGStream(rtspUrl) {
            addLog('[MJPEG] 尝试连接MJPEG流...');
            const mjpegUrl = convertRTSPtoMJPEG(rtspUrl);
            const videoElement = document.getElementById('video-player');
            videoElement.src = mjpegUrl;
            addLog('[MJPEG] MJPEG流地址: ' + mjpegUrl);
        }

        // 将RTSP转换为DASH
        function convertRTSPtoDASH(rtspUrl) {
            const streamId = encodeURIComponent(rtspUrl);
            return `${hlsServerUrl}/dash/${streamId}/manifest.mpd`;
        }

        // 将RTSP转换为MJPEG
        function convertRTSPtoMJPEG(rtspUrl) {
            const streamId = encodeURIComponent(rtspUrl);
            return `${hlsServerUrl}/mjpeg/${streamId}/stream.mjpg`;
        }

        function refreshVideoStream() {
            addLog('刷新视频流');
            
            const videoElement = document.getElementById('video-player');
            if (videoElement) {
                // 重新加载视频流
                const rtspUrl = document.getElementById('rtsp-url-input').value;
                connectWebRTCStream(rtspUrl);
                addLog('[调试] 视频流已刷新');
            }
        }

        // `:反引号；定义模板字符串的开始和结束   ${}：表示模板字符串中的变量；

        // 控制函数
        function controlMotor(action) {
            addLog(`电机控制: ${action}`);
            addLog('[调试] 电机控制命令已记录（WebSocket已禁用）');
        }

        function controlHeater(action) {
            addLog(`加热片控制: ${action}`);
            addLog('[调试] 加热片控制命令已记录（WebSocket已禁用）');
        }

        // 蓝牙开关控制
        function toggleBluetooth(enabled) {
            if (enabled) {
                addLog('[蓝牙] 蓝牙已开启');
                addLog('[调试] 正在连接OnStep设备...');
            } else {
                addLog('[蓝牙] 蓝牙已关闭');
                addLog('[调试] 正在断开OnStep设备连接...');
            }
            addLog('[调试] 蓝牙控制命令已记录（WebSocket已禁用）');
        }

        function bluetoothControl(action) {
            addLog(`[蓝牙控制] ${action}`);
            
            switch(action) {
                case 'sync-time':
                    addLog('[调试] 正在同步时间日期到OnStep设备');
                    addLog('[调试] 发送时间同步命令...');
                    break;
                case 'go-zero':
                    addLog('[调试] 正在执行回零位操作');
                    addLog('[调试] 发送回零位命令...');
                    break;
                case 'go-park':
                    addLog('[调试] 正在执行回停放位操作');
                    addLog('[调试] 发送回停放位命令...');
                    break;
                case 'set-zero':
                    addLog('[调试] 正在设置当前位置为零位');
                    addLog('[调试] 发送设置零位命令...');
                    break;
                case 'set-park':
                    addLog('[调试] 正在设置当前位置为停放位');
                    addLog('[调试] 发送设置停放位命令...');
                    break;
                default:
                    addLog('[错误] 未知的蓝牙控制命令: ' + action);
            }
            
            addLog('[调试] 蓝牙控制命令已记录（WebSocket已禁用）');
        }

        // 系统设置更新函数
        function updateSystemSetting(setting, value) {
            const timestamp = new Date().toLocaleTimeString();
            addLog(`[系统设置] ${setting}: ${value}`);
            
            // 根据设置类型进行相应处理
            switch(setting) {
                case 'report-interval':
                    addLog(`[调试] 上报间隔已更新为 ${value} 秒`);
                    break;
                case 'espnow-interval':
                    addLog(`[调试] ESP-NOW发送间隔已更新为 ${value} 秒`);
                    break;
                case 'humidity-threshold':
                    addLog(`[调试] 湿度阈值已更新为 ${value}%`);
                    // 同步更新加热片控制中的湿度阈值
                    document.getElementById('humidity-threshold').value = value;
                    break;
                case 'temp-diff-threshold':
                    addLog(`[调试] 温度差值已更新为 ${value}°C`);
                    // 同步更新加热片控制中的温度差值
                    document.getElementById('temp-diff-threshold').value = value;
                    break;
                case 'camera-auto-off':
                    addLog(`[调试] 摄像头自动关闭时间已更新为 ${value} 分钟`);
                    document.getElementById('camera-auto-off-display').textContent = value;
                    break;
            }
            
            addLog('[调试] 系统设置命令已记录（WebSocket已禁用）');
        }

        // RTSP地址更新函数
        function updateRTSPUrl(url) {
            addLog(`[摄像头配置] RTSP地址已更新: ${url}`);
            addLog(`[调试] 新的RTSP流地址: ${url}`);
            
            // 验证RTSP地址格式
            if (url.startsWith('rtsp://')) {
                addLog(`[调试] RTSP地址格式验证通过`);
            } else {
                addLog(`[警告] RTSP地址格式可能不正确，请检查`);
            }
            
            addLog('[调试] RTSP地址更新命令已记录（WebSocket已禁用）');
        }

        function restoreDefaults() {
            addLog('=== 恢复默认设置 ===');
            addLog('[调试] 开始恢复所有设置到默认值');
            
            // 恢复系统设置到默认值
            document.getElementById('report-interval').value = 5;
            document.getElementById('espnow-interval').value = 5;
            document.getElementById('humidity-threshold-setting').value = 70;
            document.getElementById('temp-diff-threshold-setting').value = 5;
            document.getElementById('camera-auto-off').value = 10;
            
            // 恢复RTSP地址到默认值
            document.getElementById('rtsp-url-input').value = 'rtsp://admin:Czh040731@10.168.1.102:554/Streaming/Channels/101?transportmode=unicast&profile=Profile_1';
            
            // 同步更新显示
            document.getElementById('humidity-threshold').value = 70;
            document.getElementById('temp-diff-threshold').value = 5;
            document.getElementById('camera-auto-off-display').textContent = '10';
            
            addLog('[调试] 上报间隔已恢复为 5 秒');
            addLog('[调试] ESP-NOW发送间隔已恢复为 5 秒');
            addLog('[调试] 湿度阈值已恢复为 70%');
            addLog('[调试] 温度差值已恢复为 5°C');
            addLog('[调试] 摄像头自动关闭时间已恢复为 10 分钟');
            addLog('[调试] RTSP地址已恢复为默认值');
            addLog('=== 默认设置恢复完成 ===');
            
            addLog('[调试] 恢复默认设置命令已记录（WebSocket已禁用）');
        }
        /*
         * 这段JavaScript的意思是：
         * 定义一个名为addLog的函数，用于在终端中添加日志消息。
         * 函数接收一个参数message，表示要添加的日志消息。
         * 首先获取id为terminal的元素，这是用于显示日志的容器。
         * 然后获取当前时间，并格式化为本地时间字符串。
         * 接着创建一个div元素，用于表示日志行。  
         * 设置该div的类名为terminal-line，并设置其文本内容为当前时间加上消息。
         * 最后将该div添加到terminal容器中，并设置滚动条位置为最新消息的位置。
         */
        function addLog(message) {
            const terminal = document.getElementById('terminal');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = 'terminal-line';
            logLine.textContent = `[${timestamp}] ${message}`;
            terminal.appendChild(logLine);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // 定时更新数据
        setInterval(updateSensorData, 5000);

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateSensorData();
            addLog('=== HTML界面初始化 ===');
            addLog('[调试] 传感器数据更新功能已启动');
            addLog('[调试] 摄像头视频流功能已就绪');
            addLog('[调试] 系统设置监控功能已启动');
            addLog('[调试] RTSP地址配置功能已就绪');
            

            
            addLog('=== 界面初始化完成 ===');
        });
    </script>
</body>
</html> 